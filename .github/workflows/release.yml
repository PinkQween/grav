name: Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  build-and-release:
    runs-on: macos-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        if ! command -v brew &> /dev/null; then
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
        fi
        arch -arm64 brew install glfw    
        arch -arm64 brew install glm
    
    - name: Build for arm64
      run: |
        mkdir -p build/arm64

        clang++ -arch arm64 -I/opt/homebrew/include -std=c++11 main.cpp -arch arm64 -L/opt/homebrew/lib -lglfw -framework Cocoa -framework OpenGL -framework IOKit -o build/arm64/grav

        mkdir -p build/arm64/Grav.app/Contents/MacOS
        mkdir -p build/arm64/Grav.app/Contents/Resources

        cp build/arm64/grav build/arm64/Grav.app/Contents/MacOS/
        cp -r Resources/* build/arm64/Grav.app/Contents/Resources/ 2>/dev/null || true
        cp Info.plist build/arm64/Grav.app/Contents/ 2>/dev/null || true

        cd build/arm64
        zip -r ../../grav-arm64.zip Grav.app
        cd ../..

        zip grav-arm64-binary.zip build/arm64/grav
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: grav-arm64
        path: |
          grav-arm64.zip
          grav-arm64-binary.zip
    
    - name: Create Release (if on main/master)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}-${{ github.sha }}
        name: "Grav Build ${{ github.run_number }}"
        body: |
          Automated build from commit ${{ github.sha }}
          
          ## Downloads
          - **Apple Silicon (M1/M2/M3/M4 Macs)**: `grav-arm64.zip` or `grav-arm64-binary.zip`
          
          ## Installation
          1. Download the appropriate zip file for your Mac architecture
          2. Extract the zip file
          3. For the app bundle (.app), drag to Applications folder
          4. For the binary, place in your PATH or run directly
        files: |
          grav-arm64.zip
          grav-arm64-binary.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
